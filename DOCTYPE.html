<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{device_id} 控制台</title>
<style>
body { font-family: Arial; margin: 0; padding: 20px; background: #f5f5f5;}
.container { max-width: 800px; margin: 0 auto; margin-top: 40px;}
.console-panel { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 9px rgba(0,0,0,.08);}
h1 { color: #333; text-align: center; }
.tab-nav { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px;}
.tab-btn {padding:14px 26px;font-weight:bold;color:#666;cursor:pointer;background:none;border:none;font-size:16px;border-bottom:2px solid transparent;}
.tab-btn.active {color:#007bff;border-bottom-color:#007bff;}
.tab-content {display:none;}
.tab-content.active {display:block;}
.button-group {margin:12px 0; text-align:center;}
.btn {padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; background:#007bff;}
.btn-danger {background:#dc3545;} .btn-warning {background:#ffc107;color:#333;}
</style>
</head>
<body>
<div class="container"><div class="console-panel">
    <h1>{device_id} 控制台</h1>
    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('status')">状态</button>
        <button class="tab-btn" onclick="showTab('wifi')">WiFi</button>
        <button class="tab-btn" onclick="showTab('gpio')">GPIO</button>
        <button class="tab-btn" onclick="showTab('frp')">FRP</button>
        <button class="tab-btn" onclick="showTab('system')">系统</button>
    </div>
    <!-- 状态 -->
    <div id="tab-status" class="tab-content active">
        <div>CPU: <b id="cpu_freq"></b> &nbsp; 内存: <b id="free_mem"></b> &nbsp; WiFi: <b id="wifi_status"></b><br>
            FRP: <b id="frp_status"></b> &nbsp; 运行: <b id="uptime"></b></div>
        <div style="margin:12px 0">
            <button class="btn" onclick="updateStatus()">刷新状态</button>
            <button class="btn btn-warning" onclick="restartDevice()">重启设备</button>
        </div>
    </div>
    <!-- WiFi -->
    <div id="tab-wifi" class="tab-content">
        <div>SSID: <input id="wifi_ssid" placeholder="WiFi名称"> 密码: <input id="wifi_password" type="password" placeholder="WiFi密码">
            <button class="btn" onclick="connectWifi()">连接</button>
            <button class="btn btn-danger" onclick="disconnectWifi()">断开</button>
            <button class="btn" onclick="scanWifi()">扫描WiFi</button></div>
        <div id="wifi_networks"></div>
    </div>
    <!-- GPIO -->
    <div id="tab-gpio" class="tab-content">
        <div>引脚:
            <select id="gpio_pin">
                <option>14</option><option>13</option><option>12</option><option>11</option><option>10</option>
                <option>9</option><option>46</option><option>3</option><option>8</option><option>18</option>
                <option>17</option><option>16</option><option>15</option><option>7</option><option>6</option>
                <option>5</option><option>4</option><option>20</option><option>21</option><option>47</option>
                <option>48</option><option>45</option><option>0</option><option>35</option><option>36</option>
                <option>37</option><option>38</option><option>39</option><option>40</option><option>41</option>
                <option>42</option><option>2</option><option>1</option>
            </select>
        </div>
        <div class="button-group">
            <button class="btn" onclick="gpioSet(1)">高电平</button>
            <button class="btn btn-danger" onclick="gpioSet(0)">低电平</button>
            <button class="btn" onclick="gpioRead()">读取</button>
        </div>
        <div>
            <button class="btn btn-warning" onclick="openWaveDialog('square')">方波波形</button>
            <button class="btn btn-warning" onclick="openWaveDialog('sin')">正弦波波形</button>
        </div>
        <div id="gpio_log"></div>
    </div>
    <!-- FRP -->
    <div id="tab-frp" class="tab-content">
        <p>FRP状态: <b id="frp_status2"></b></p>
        <button class="btn" onclick="startFRP()">启动隧道</button>
        <button class="btn btn-danger" onclick="stopFRP()">停止隧道</button>
        <div style="margin-top:8px;">
            <label>FRP服务器:</label>
            <input id="frp_server" placeholder="如 1.2.3.4">
            <label>端口:</label>
            <input id="frp_port" placeholder="端口" type="number">
            <label>Token:</label>
            <input id="frp_token" placeholder="Token">
            <button class="btn" onclick="saveFrpConfig()">保存服务器配置</button>
        </div>
    </div>
    <!-- 系统 -->
    <div id="tab-system" class="tab-content">
        <div>CPU频率:
        <select id="cpu_freq_select" onchange="setCpuFreq(this.value)">
            <option value="80">80MHz</option><option value="160">160MHz</option><option value="240" selected>240MHz</option>
        </select></div>
        <div>
            <button class="btn btn-warning" onclick="factoryReset()">恢复出厂</button>
        </div>
    </div>
</div></div>
<script>
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+tabId).classList.add('active');
    event.target.classList.add('active');
}
function updateStatus() {
    fetch('/status').then(r=>r.json()).then(status=>{
        document.getElementById('cpu_freq').textContent = status.cpu_freq+'MHz';
        document.getElementById('free_mem').textContent = status.free_mem+'KB';
        document.getElementById('wifi_status').textContent = status.wifi_connected ? '已连接:' + status.wifi_ssid : '未连接';
        document.getElementById('frp_status').textContent = status.frp_running ? '运行中':'未运行';
        document.getElementById('frp_status2').textContent = status.frp_running ? '运行中':'未运行';
        document.getElementById('uptime').textContent = status.uptime+'秒';
    });
}
function connectWifi() {
    fetch('/wifi/connect?ssid='+encodeURIComponent(document.getElementById('wifi_ssid').value)+'&password='+encodeURIComponent(document.getElementById('wifi_password').value))
        .then(r=>r.text()).then(data=>{alert(data); updateStatus();});
}
function disconnectWifi() {
    fetch('/wifi/disconnect').then(r=>r.text()).then(data=>{alert(data); updateStatus();});
}
function scanWifi() {
    fetch('/wifi/scan').then(r=>r.json()).then(data=>{
        let netList = document.getElementById('wifi_networks');
        netList.innerHTML="";
        data.forEach(net=>{
            let o = document.createElement('div');
            o.textContent = `${net.ssid} | 信号${net.rssi}dBm | 信道${net.channel}`;
            netList.appendChild(o);
        });
    });
}
function gpioSet(val) {
    const pin = document.getElementById('gpio_pin').value;
    fetch(`/gpio/set?pin=${pin}&value=${val}`).then(r=>r.text()).then(d=>{
        document.getElementById('gpio_log').textContent=d;
    });
}
function gpioRead() {
    const pin = document.getElementById('gpio_pin').value;
    fetch(`/gpio/read?pin=${pin}`).then(r=>r.text()).then(d=>{
        document.getElementById('gpio_log').textContent='GPIO值:'+d;
    });
}
function setCpuFreq(val) {
    fetch('/system/cpu_freq?value='+val).then(r=>r.text()).then(d=>alert(d));
}
function restartDevice() {
    if(confirm('确定要重启?')) fetch('/restart').then(r=>r.text()).then(d=>alert(d));
}
function factoryReset() {
    if(confirm('是否恢复出厂设置?')) fetch('/factory_reset').then(r=>r.text()).then(d=>alert(d));
}
function startFRP() {
    fetch('/frp/start').then(r=>r.text()).then(d=>{
        document.getElementById('frp_status').textContent = '运行中';
        document.getElementById('frp_status2').textContent = '运行中';
        alert(d);
    });
}
function stopFRP() {
    fetch('/frp/stop').then(r=>r.text()).then(d=>{
        document.getElementById('frp_status').textContent = '未运行';
        document.getElementById('frp_status2').textContent = '未运行';
        alert(d);
    });
}
function saveFrpConfig() {
    const s = encodeURIComponent(document.getElementById('frp_server').value);
    const p = encodeURIComponent(document.getElementById('frp_port').value);
    const t = encodeURIComponent(document.getElementById('frp_token').value);
    fetch(`/frp/config?server=${s}&port=${p}&token=${t}`).then(r=>r.json()).then(cfg=>{
        alert(`FRP服务器设置已保存:\n地址:${cfg.server}\n端口:${cfg.port}\nToken:${cfg.token}`);
    });
}
function getFrpConfig() {
    fetch('/frp/config').then(r=>r.json()).then(cfg=>{
        document.getElementById('frp_server').value = cfg.server || "";
        document.getElementById('frp_port').value = cfg.port || "";
        document.getElementById('frp_token').value = cfg.token || "";
    });
}
function openWaveDialog(type) {
    let freq = prompt("设置输出频率 Hz（如50-2000）：", "500");
    if(!freq) return;
    let pin = document.getElementById('gpio_pin').value;
    fetch(`/gpio/wave?pin=${pin}&type=${type}&freq=${freq}`).then(r=>r.text()).then(d=>alert(d));
}
document.addEventListener('DOMContentLoaded',function(){updateStatus();getFrpConfig();});
setInterval(updateStatus, 30000);
</script>
</body>
</html>